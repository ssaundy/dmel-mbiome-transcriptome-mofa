#!/bin/bash
#PBS -N SALMON_QUANT
#PBS -l walltime=01:30:00,mem=4gb,nodes=1:ppn=2
#PBS -M 2482773s@student.gla.ac.uk
#PBS -m abe
#PBS -j oe
#PBS -t 1-119%10
#PBS -o /export/biostuds/2482773s/THESIS/RNAseq/logs/

cd /export/biostuds/2482773s/THESIS/RNAseq
source /export/biostuds/2482773s/.bashrc
conda activate rnaseq
set -e

# Define directories
CUTADAPT_DIR="analysis/cutadapt_quantseq"
SALMON_INDEX="analysis/salmon_index"
SALMON_OUTPUT="analysis/salmon_quant"

# Create output directory
mkdir -p ${SALMON_OUTPUT}

# Get all cutadapt-trimmed files and select the one for this array job
SAMPLE_FILES=($(ls ${CUTADAPT_DIR}/*_R1_quantseq.fastq.gz | sort))
SAMPLE_FILE=${SAMPLE_FILES[$((PBS_ARRAYID-1))]}
SAMPLE=$(basename "$SAMPLE_FILE" _R1_quantseq.fastq.gz)

# Run salmon quantification
salmon quant \
        -i ${SALMON_INDEX} \
        -l A \
        -r "$SAMPLE_FILE" \
        -o ${SALMON_OUTPUT}/${SAMPLE} \
        --threads 2 \
        --numBootstraps 100 \
        --seqBias \
        --gcBias \
        --validateMappings